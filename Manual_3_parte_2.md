# üìö MANUAL 3 - PARTE 2: MODELOS DE DATOS CON MONGOOSE

## üìã INFORMACI√ìN DEL MANUAL

**Proyecto:** Sistema E-commerce Tecnol√≥gico - Manual 3 (Parte 2/4)  
**Prerequisito:** Manual 3 Parte 1 completado (MongoDB Atlas conectado)  
**Tiempo Estimado:** 45 minutos  
**Sesi√≥n del Cronograma:** 3 (MongoDB + Base de datos)  
**Estado:** MANUAL COMPLETO PASO A PASO ‚úÖ

---

## ‚ö†Ô∏è REQUISITOS PREVIOS

- ‚úÖ **Manual 3 - Parte 1** completado exitosamente
- ‚úÖ **MongoDB Atlas** conectado y funcionando
- ‚úÖ **Backend corriendo** con mensajes de conexi√≥n exitosa
- ‚úÖ **Frontend funcionando** correctamente
- ‚úÖ **Visual Studio Code** abierto en la carpeta del proyecto

---

## üéØ OBJETIVOS DE LA PARTE 2

**CREAR:** Modelos de datos profesionales para tu e-commerce

**AL FINALIZAR ESTA PARTE TENDR√ÅS:**
- üìä **Modelo Product** con validaciones completas y campos avanzados
- üë§ **Modelo User** preparado para autenticaci√≥n JWT
- üõí **Modelo Order** preparado para sistema de pedidos
- üîó **Relaciones entre modelos** bien definidas
- ‚úÖ **Validaciones robustas** y manejo de errores

---

## üìÖ PLAN DE TRABAJO (45 MINUTOS)

### **FASE 1: ESTRUCTURA DE MODELOS** (10 minutos)
- Crear carpeta models y archivo √≠ndice
- Configurar exportaciones centralizadas

### **FASE 2: MODELO PRODUCT** (15 minutos)
- Crear modelo con todos los campos de tus productos
- Validaciones, √≠ndices y virtuals

### **FASE 3: MODELO USER** (10 minutos)
- Crear modelo preparado para autenticaci√≥n
- Encriptaci√≥n de passwords y roles

### **FASE 4: MODELO ORDER** (10 minutos)
- Crear modelo para sistema de pedidos
- Relaciones con Product y User

---

## üóÇÔ∏è FASE 1: ESTRUCTURA DE MODELOS (10 MINUTOS)

### **PASO 1.1: Crear carpeta models**

#### **1.1.1 Crear directorio**
```bash
cd backend
mkdir models
```

#### **1.1.2 Verificar creaci√≥n**
```bash
# Windows
dir models

# Linux/Mac
ls -la models
```

### **PASO 1.2: Crear archivo √≠ndice de modelos**

#### **1.2.1 Crear models/index.js**
**Crear archivo:** `backend/models/index.js`

**PEGAR este contenido completo:**

```javascript
// Archivo central de exportaci√≥n de modelos
const Product = require('./Product');
const User = require('./User');
const Order = require('./Order');

module.exports = {
  Product,
  User,
  Order
};
```

**¬øPara qu√© sirve este archivo?**
- üéØ **Centraliza importaciones** - un solo lugar para importar todos los modelos
- üîß **Facilita mantenimiento** - cambios en un solo archivo
- üì¶ **Importaci√≥n limpia** - `const { Product, User } = require('./models')`

---

## üìä FASE 2: MODELO PRODUCT (15 MINUTOS)

### **PASO 2.1: Crear modelo Product completo**

#### **2.1.1 Crear models/Product.js**
**Crear archivo:** `backend/models/Product.js`

**PEGAR este contenido completo:**

```javascript
const mongoose = require('mongoose');

// Esquema para productos del e-commerce
const productSchema = new mongoose.Schema({
  // Informaci√≥n b√°sica del producto
  name: {
    type: String,
    required: [true, 'El nombre del producto es obligatorio'],
    trim: true,
    maxlength: [100, 'El nombre no puede exceder 100 caracteres'],
    index: true // √çndice para b√∫squedas r√°pidas
  },
  
  description: {
    type: String,
    required: [true, 'La descripci√≥n es obligatoria'],
    maxlength: [1000, 'La descripci√≥n no puede exceder 1000 caracteres']
  },
  
  price: {
    type: Number,
    required: [true, 'El precio es obligatorio'],
    min: [0, 'El precio no puede ser negativo'],
    validate: {
      validator: function(v) {
        return v > 0;
      },
      message: 'El precio debe ser mayor a 0'
    }
  },
  
  images: [{
    type: String,
    validate: {
      validator: function(v) {
        return /^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(v);
      },
      message: 'Cada imagen debe ser una URL v√°lida'
    }
  }],
  
  // Categorizaci√≥n
  category: {
    type: String,
    required: [true, 'La categor√≠a es obligatoria'],
    enum: {
      values: [
        'Smartphones', 
        'Laptops', 
        'Audio', 
        'Wearables', 
        'Tablets', 
        'Accessories', 
        'Gaming', 
        'Home',
        'Electronics',
        'Computers'
      ],
      message: '{VALUE} no es una categor√≠a v√°lida'
    },
    index: true
  },
  
  // Caracter√≠sticas avanzadas del producto
  features: [{
    type: String,
    maxlength: [200, 'Cada caracter√≠stica no puede exceder 200 caracteres']
  }],
  
  specifications: {
    type: Map,
    of: String,
    validate: {
      validator: function(map) {
        if (!map) return true;
        return map.size <= 20; // M√°ximo 20 especificaciones
      },
      message: 'No se pueden tener m√°s de 20 especificaciones'
    }
  },
  
  // Inventario y disponibilidad
  stock: {
    type: Number,
    required: [true, 'El stock es obligatorio'],
    min: [0, 'El stock no puede ser negativo'],
    default: 0
  },
  
  // Sistema de calificaciones
  rating: {
    type: Number,
    min: [0, 'La calificaci√≥n m√≠nima es 0'],
    max: [5, 'La calificaci√≥n m√°xima es 5'],
    default: 0,
    validate: {
      validator: function(v) {
        return v === 0 || (v >= 1 && v <= 5);
      },
      message: 'La calificaci√≥n debe ser 0 o entre 1 y 5'
    }
  },
  
  reviewCount: {
    type: Number,
    min: [0, 'El n√∫mero de rese√±as no puede ser negativo'],
    default: 0
  },
  
  // Control de estado
  isActive: {
    type: Boolean,
    default: true,
    index: true
  },
  
  // SEO y marketing
  slug: {
    type: String,
    unique: true,
    lowercase: true,
    index: true
  },
  
  tags: [{
    type: String,
    trim: true,
    lowercase: true,
    maxlength: [50, 'Cada tag no puede exceder 50 caracteres']
  }],
  
  // M√©tricas de negocio
  
  salesCount: {
    type: Number,
    default: 0,
    min: [0, 'Las ventas no pueden ser negativas']
  }
  
}, {
  timestamps: true, // Agrega createdAt y updatedAt autom√°ticamente
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// ===== VIRTUALS (Campos calculados) =====

// Virtual para verificar si est√° en stock
productSchema.virtual('inStock').get(function() {
  return this.stock > 0;
});

// Virtual para formato de precio con moneda
productSchema.virtual('formattedPrice').get(function() {
  return `$${this.price.toLocaleString('es-CO')}`;
});

// Virtual para URL amigable
productSchema.virtual('url').get(function() {
  return `/products/${this.slug || this._id}`;
});

// Virtual para calcular descuento (si fuera necesario)
productSchema.virtual('discountPercentage').get(function() {
  if (this.originalPrice && this.originalPrice > this.price) {
    return Math.round(((this.originalPrice - this.price) / this.originalPrice) * 100);
  }
  return 0;
});

// ===== √çNDICES PARA OPTIMIZAR B√öSQUEDAS =====

// √çndice compuesto para b√∫squedas complejas
productSchema.index({ name: 'text', description: 'text', tags: 'text' });
productSchema.index({ category: 1, isActive: 1 });
productSchema.index({ price: 1, rating: -1 });
productSchema.index({ createdAt: -1 });
productSchema.index({ salesCount: -1 });

// ===== MIDDLEWARE PRE-SAVE =====

productSchema.pre('save', function(next) {
  // Generar slug autom√°ticamente si no existe
  if (!this.slug && this.name) {
    this.slug = this.name
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '') // Remover caracteres especiales
      .replace(/\s+/g, '-') // Reemplazar espacios con guiones
      .replace(/-+/g, '-') // M√∫ltiples guiones a uno
      .trim('-'); // Remover guiones al inicio/final
  }
  
  // Convertir nombre a formato t√≠tulo
  if (this.name) {
    this.name = this.name.replace(/\w\S*/g, (txt) => 
      txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
    );
  }
  
  // Validar que el rating tenga sentido con reviewCount
  if (this.rating > 0 && this.reviewCount === 0) {
    this.reviewCount = 1;
  }
  
  // Asegurar que image est√© en el array images
  if (this.image && (!this.images || this.images.length === 0)) {
    this.images = [this.image];
  }
  
  next();
});

// ===== M√âTODOS DEL MODELO =====

// M√©todo para actualizar rating
productSchema.methods.updateRating = function(newRating) {
  const totalRating = (this.rating * this.reviewCount) + newRating;
  this.reviewCount += 1;
  this.rating = Number((totalRating / this.reviewCount).toFixed(1));
  return this.save();
};

// M√©todo para incrementar vistas
productSchema.methods.incrementViews = function() {
  this.viewCount += 1;
  return this.save();
};

// M√©todo para incrementar ventas
productSchema.methods.incrementSales = function(quantity = 1) {
  this.salesCount += quantity;
  if (this.stock >= quantity) {
    this.stock -= quantity;
  }
  return this.save();
};

// ===== M√âTODOS EST√ÅTICOS =====

// Buscar productos por categor√≠a
productSchema.statics.findByCategory = function(category) {
  return this.find({ category, isActive: true }).sort({ createdAt: -1 });
};

// Buscar productos en stock
productSchema.statics.findInStock = function() {
  return this.find({ stock: { $gt: 0 }, isActive: true });
};

// Buscar productos populares
productSchema.statics.findPopular = function(limit = 10) {
  return this.find({ isActive: true })
    .sort({ salesCount: -1, rating: -1 })
    .limit(limit);
};

module.exports = mongoose.model('Product', productSchema);
```

#### **2.1.2 ¬øQu√© incluye este modelo Product?**

**üìã CAMPOS B√ÅSICOS:**
- `name` - Nombre del producto con validaci√≥n
- `description` - Descripci√≥n detallada
- `price` - Precio con validaci√≥n de n√∫mero positivo
- `image` - Imagen principal con validaci√≥n de URL
- `images` - Array de m√∫ltiples im√°genes
- `category` - Categor√≠a con valores espec√≠ficos permitidos

**üéØ CAMPOS AVANZADOS:**
- `features` - Array de caracter√≠sticas del producto
- `specifications` - Map de especificaciones t√©cnicas
- `stock` - Control de inventario
- `rating` - Sistema de calificaciones (0-5)
- `reviewCount` - N√∫mero de rese√±as
- `slug` - URL amigable para SEO
- `tags` - Etiquetas para b√∫squedas

**üìä M√âTRICAS DE NEGOCIO:**
- `salesCount` - N√∫mero de ventas realizadas
- `isActive` - Control de visibilidad

**üöÄ FUNCIONALIDADES AVANZADAS:**
- **Virtuals:** Campos calculados como `inStock`, `formattedPrice`
- **√çndices:** Para b√∫squedas r√°pidas y eficientes
- **Middleware:** Auto-generaci√≥n de slug y validaciones
- **M√©todos:** Para actualizar rating, vistas y ventas

---

## üë§ FASE 3: MODELO USER (10 MINUTOS)

### **PASO 3.1: Instalar bcryptjs para encriptaci√≥n**

#### **3.1.1 Instalar dependencia**
```bash
cd backend
npm install bcryptjs
```

### **PASO 3.2: Crear modelo User**

#### **3.2.1 Crear models/User.js**
**Crear archivo:** `backend/models/User.js`

**PEGAR este contenido completo:**

```javascript
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');

// Esquema para usuarios del sistema
const userSchema = new mongoose.Schema({
  // Informaci√≥n personal
  name: {
    type: String,
    required: [true, 'El nombre es obligatorio'],
    trim: true,
    maxlength: [50, 'El nombre no puede exceder 50 caracteres'],
    minlength: [2, 'El nombre debe tener al menos 2 caracteres']
  },
  
  email: {
    type: String,
    required: [true, 'El email es obligatorio'],
    unique: true,
    lowercase: true,
    trim: true,
    match: [
      /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,
      'Por favor ingresa un email v√°lido'
    ],
    index: true
  },
  
  password: {
    type: String,
    required: [true, 'La contrase√±a es obligatoria'],
    minlength: [6, 'La contrase√±a debe tener al menos 6 caracteres'],
    select: false // No incluir password en consultas por defecto
  },
  
  // Informaci√≥n de perfil
  avatar: {
    type: String,
    default: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
    validate: {
      validator: function(v) {
        return /^https?:\/\/.+/.test(v);
      },
      message: 'Debe ser una URL v√°lida'
    }
  },
  
  phone: {
    type: String,
    trim: true,
    validate: {
      validator: function(v) {
        return !v || /^[\+]?[1-9][\d]{0,15}$/.test(v);
      },
      message: 'N√∫mero de tel√©fono inv√°lido'
    }
  },
  
  // Sistema de roles
  role: {
    type: String,
    enum: {
      values: ['customer', 'admin', 'moderator'],
      message: '{VALUE} no es un rol v√°lido'
    },
    default: 'customer'
  },
  
  // Informaci√≥n de direcci√≥n
  address: {
    street: {
      type: String,
      trim: true,
      maxlength: [100, 'La direcci√≥n no puede exceder 100 caracteres']
    },
    city: {
      type: String,
      trim: true,
      maxlength: [50, 'La ciudad no puede exceder 50 caracteres']
    },
    state: {
      type: String,
      trim: true,
      maxlength: [50, 'El estado no puede exceder 50 caracteres']
    },
    zipCode: {
      type: String,
      trim: true,
      maxlength: [20, 'El c√≥digo postal no puede exceder 20 caracteres']
    },
    country: {
      type: String,
      default: 'Colombia',
      maxlength: [50, 'El pa√≠s no puede exceder 50 caracteres']
    }
  },
  
  // Control de cuenta
  isActive: {
    type: Boolean,
    default: true
  },
  
  emailVerified: {
    type: Boolean,
    default: false
  },
  
  // Fechas importantes
  lastLogin: {
    type: Date
  },
  
  // Preferencias del usuario
  preferences: {
    newsletter: {
      type: Boolean,
      default: true
    },
    notifications: {
      type: Boolean,
      default: true
    },
    language: {
      type: String,
      enum: ['es', 'en'],
      default: 'es'
    }
  },
  
  // Tokens para recuperaci√≥n de contrase√±a
  resetPasswordToken: String,
  resetPasswordExpire: Date

}, {
  timestamps: true,
  toJSON: { 
    virtuals: true,
    transform: function(doc, ret) {
      delete ret.password;
      delete ret.resetPasswordToken;
      delete ret.resetPasswordExpire;
      return ret;
    }
  }
});

// ===== VIRTUALS =====

// Virtual para obtener iniciales
userSchema.virtual('initials').get(function() {
  return this.name.split(' ').map(n => n[0]).join('').toUpperCase();
});

// Virtual para nombre completo de direcci√≥n
userSchema.virtual('fullAddress').get(function() {
  if (!this.address.street) return '';
  
  const parts = [
    this.address.street,
    this.address.city,
    this.address.state,
    this.address.zipCode,
    this.address.country
  ].filter(part => part);
  
  return parts.join(', ');
});

// ===== √çNDICES =====
userSchema.index({ email: 1 });
userSchema.index({ role: 1 });
userSchema.index({ createdAt: -1 });
userSchema.index({ 'address.city': 1 });

// ===== MIDDLEWARE PRE-SAVE =====

// Encriptar password antes de guardar
userSchema.pre('save', async function(next) {
  // Solo encriptar si el password fue modificado
  if (!this.isModified('password')) return next();
  
  try {
    // Generar salt y encriptar password
    const salt = await bcrypt.genSalt(12);
    this.password = await bcrypt.hash(this.password, salt);
    next();
  } catch (error) {
    next(error);
  }
});

// Actualizar lastLogin cuando se modifica
userSchema.pre('save', function(next) {
  if (this.isModified('lastLogin')) {
    this.lastLogin = new Date();
  }
  next();
});

// ===== M√âTODOS DEL MODELO =====

// M√©todo para comparar passwords
userSchema.methods.comparePassword = async function(candidatePassword) {
  try {
    return await bcrypt.compare(candidatePassword, this.password);
  } catch (error) {
    throw error;
  }
};

// M√©todo para actualizar √∫ltimo login
userSchema.methods.updateLastLogin = function() {
  this.lastLogin = new Date();
  return this.save();
};

// M√©todo para verificar si es admin
userSchema.methods.isAdmin = function() {
  return this.role === 'admin';
};

// M√©todo para verificar si puede moderar
userSchema.methods.canModerate = function() {
  return this.role === 'admin' || this.role === 'moderator';
};

// ===== M√âTODOS EST√ÅTICOS =====

// Encontrar usuarios por rol
userSchema.statics.findByRole = function(role) {
  return this.find({ role, isActive: true });
};

// Encontrar usuarios activos
userSchema.statics.findActive = function() {
  return this.find({ isActive: true }).sort({ createdAt: -1 });
};

// Buscar usuario por email (incluyendo password)
userSchema.statics.findByEmailWithPassword = function(email) {
  return this.findOne({ email }).select('+password');
};

module.exports = mongoose.model('User', userSchema);
```

#### **3.2.2 ¬øQu√© incluye este modelo User?**

**üÜî AUTENTICACI√ìN:**
- `email` - Email √∫nico con validaci√≥n
- `password` - Contrase√±a encriptada con bcryptjs
- `role` - Sistema de roles (customer, admin, moderator)
- `emailVerified` - Control de verificaci√≥n de email

**üë§ PERFIL PERSONAL:**
- `name` - Nombre completo
- `avatar` - Imagen de perfil
- `phone` - Tel√©fono con validaci√≥n
- `address` - Direcci√≥n completa estructurada

**‚öôÔ∏è PREFERENCIAS:**
- `newsletter` - Suscripci√≥n a newsletter
- `notifications` - Recibir notificaciones
- `language` - Idioma preferido (es/en)

**üîê SEGURIDAD:**
- Encriptaci√≥n autom√°tica de contrase√±as
- M√©todos para comparar contrase√±as
- Tokens para recuperaci√≥n de contrase√±a
- Exclusi√≥n autom√°tica de datos sensibles

---

## üõí FASE 4: MODELO ORDER (10 MINUTOS)

### **PASO 4.1: Crear modelo Order**

#### **4.1.1 Crear models/Order.js**
**Crear archivo:** `backend/models/Order.js`

**PEGAR este contenido completo:**

```javascript
const mongoose = require('mongoose');

// Sub-esquema para items de la orden
const orderItemSchema = new mongoose.Schema({
  product: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Product',
    required: true
  },
  
  // Informaci√≥n del producto al momento de la compra
  name: {
    type: String,
    required: true
  },
  
  image: {
    type: String,
    required: true
  },
  
  price: {
    type: Number,
    required: true,
    min: 0
  },
  
  quantity: {
    type: Number,
    required: true,
    min: 1
  },
  
  subtotal: {
    type: Number,
    required: true,
    min: 0
  }
});

// Esquema principal de √≥rdenes
const orderSchema = new mongoose.Schema({
  // Identificaci√≥n de la orden
  orderNumber: {
    type: String,
    required: true,
    unique: true,
    index: true
  },
  
  // Relaci√≥n con el usuario
  user: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
    index: true
  },
  
  // Items de la orden
  items: [orderItemSchema],
  
  // Informaci√≥n financiera
  subtotalAmount: {
    type: Number,
    required: true,
    min: 0
  },
  
  shippingCost: {
    type: Number,
    default: 0,
    min: 0
  },
  
  tax: {
    type: Number,
    default: 0,
    min: 0
  },
  
  discount: {
    type: Number,
    default: 0,
    min: 0
  },
  
  totalAmount: {
    type: Number,
    required: true,
    min: 0
  },
  
  // Estados de la orden
  status: {
    type: String,
    enum: {
      values: ['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled', 'returned'],
      message: '{VALUE} no es un estado v√°lido'
    },
    default: 'pending',
    index: true
  },
  
  // Informaci√≥n de pago
  paymentMethod: {
    type: String,
    enum: {
      values: ['credit_card', 'debit_card', 'paypal', 'bank_transfer', 'cash_on_delivery'],
      message: '{VALUE} no es un m√©todo de pago v√°lido'
    },
    required: true
  },
  
  paymentStatus: {
    type: String,
    enum: {
      values: ['pending', 'paid', 'failed', 'refunded', 'partially_refunded'],
      message: '{VALUE} no es un estado de pago v√°lido'
    },
    default: 'pending',
    index: true
  },
  
  paymentId: String, // ID de transacci√≥n del procesador de pagos
  
  // Direcciones
  shippingAddress: {
    street: { type: String, required: true },
    city: { type: String, required: true },
    state: { type: String, required: true },
    zipCode: { type: String, required: true },
    country: { type: String, default: 'Colombia' },
    phone: String
  },
  
  billingAddress: {
    street: String,
    city: String,
    state: String,
    zipCode: String,
    country: String,
    phone: String
  },
  
  // Informaci√≥n de env√≠o
  shippingMethod: {
    type: String,
    enum: ['standard', 'express', 'overnight', 'pickup'],
    default: 'standard'
  },
  
  trackingNumber: String,
  
  estimatedDelivery: Date,
  
  deliveredAt: Date,
  
  // Notas y comentarios
  notes: {
    type: String,
    maxlength: [500, 'Las notas no pueden exceder 500 caracteres']
  },
  
  // Historial de cambios de estado
  statusHistory: [{
    status: String,
    changedAt: {
      type: Date,
      default: Date.now
    },
    changedBy: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    },
    notes: String
  }]
  
}, {
  timestamps: true,
  toJSON: { virtuals: true }
});

// ===== VIRTUALS =====

// Virtual para el total de items
orderSchema.virtual('itemCount').get(function() {
  return this.items.reduce((total, item) => total + item.quantity, 0);
});

// Virtual para verificar si la orden est√° completada
orderSchema.virtual('isCompleted').get(function() {
  return ['delivered', 'cancelled', 'returned'].includes(this.status);
});

// Virtual para verificar si se puede cancelar
orderSchema.virtual('canBeCancelled').get(function() {
  return ['pending', 'confirmed'].includes(this.status);
});

// Virtual para direcci√≥n de env√≠o formateada
orderSchema.virtual('formattedShippingAddress').get(function() {
  const addr = this.shippingAddress;
  return `${addr.street}, ${addr.city}, ${addr.state} ${addr.zipCode}, ${addr.country}`;
});

// ===== √çNDICES =====
orderSchema.index({ user: 1, createdAt: -1 });
orderSchema.index({ orderNumber: 1 });
orderSchema.index({ status: 1, createdAt: -1 });
orderSchema.index({ paymentStatus: 1 });
orderSchema.index({ 'items.product': 1 });

// ===== MIDDLEWARE PRE-SAVE =====

// Generar n√∫mero de orden autom√°ticamente
orderSchema.pre('save', async function(next) {
  if (this.isNew && !this.orderNumber) {
    const count = await mongoose.model('Order').countDocuments();
    const timestamp = Date.now().toString().slice(-6);
    this.orderNumber = `ORD-${timestamp}-${(count + 1).toString().padStart(4, '0')}`;
  }
  next();
});

// Calcular totales autom√°ticamente
orderSchema.pre('save', function(next) {
  if (this.items && this.items.length > 0) {
    // Calcular subtotal
    this.subtotalAmount = this.items.reduce((total, item) => total + item.subtotal, 0);
    
    // Calcular total final
    this.totalAmount = this.subtotalAmount + this.shippingCost + this.tax - this.discount;
    
    // Asegurar que el total no sea negativo
    if (this.totalAmount < 0) {
      this.totalAmount = 0;
    }
  }
  next();
});

// Actualizar historial de estado
orderSchema.pre('save', function(next) {
  if (this.isModified('status') && !this.isNew) {
    this.statusHistory.push({
      status: this.status,
      changedAt: new Date()
    });
  }
  next();
});

// ===== M√âTODOS DEL MODELO =====

// M√©todo para actualizar estado
orderSchema.methods.updateStatus = function(newStatus, changedBy, notes) {
  this.status = newStatus;
  
  if (changedBy || notes) {
    this.statusHistory.push({
      status: newStatus,
      changedBy,
      notes,
      changedAt: new Date()
    });
  }
  
  // Actualizar fecha de entrega si es delivered
  if (newStatus === 'delivered') {
    this.deliveredAt = new Date();
  }
  
  return this.save();
};

// M√©todo para calcular el total
orderSchema.methods.calculateTotal = function() {
  this.subtotalAmount = this.items.reduce((total, item) => total + item.subtotal, 0);
  this.totalAmount = this.subtotalAmount + this.shippingCost + this.tax - this.discount;
  
  if (this.totalAmount < 0) {
    this.totalAmount = 0;
  }
  
  return this;
};

// M√©todo para agregar item
orderSchema.methods.addItem = function(productId, productData, quantity) {
  const existingItem = this.items.find(item => 
    item.product.toString() === productId.toString()
  );
  
  if (existingItem) {
    existingItem.quantity += quantity;
    existingItem.subtotal = existingItem.price * existingItem.quantity;
  } else {
    this.items.push({
      product: productId,
      name: productData.name,
      image: productData.image,
      price: productData.price,
      quantity: quantity,
      subtotal: productData.price * quantity
    });
  }
  
  return this.calculateTotal();
};

// M√©todo para remover item
orderSchema.methods.removeItem = function(productId) {
  this.items = this.items.filter(item => 
    item.product.toString() !== productId.toString()
  );
  
  return this.calculateTotal();
};

// ===== M√âTODOS EST√ÅTICOS =====

// Encontrar √≥rdenes por usuario
orderSchema.statics.findByUser = function(userId) {
  return this.find({ user: userId }).sort({ createdAt: -1 }).populate('user', 'name email');
};

// Encontrar √≥rdenes por estado
orderSchema.statics.findByStatus = function(status) {
  return this.find({ status }).sort({ createdAt: -1 }).populate('user', 'name email');
};

// Obtener estad√≠sticas de √≥rdenes
orderSchema.statics.getOrderStats = async function() {
  const stats = await this.aggregate([
    {
      $group: {
        _id: '$status',
        count: { $sum: 1 },
        totalAmount: { $sum: '$totalAmount' }
      }
    }
  ]);
  
  return stats;
};

// Obtener √≥rdenes recientes
orderSchema.statics.getRecentOrders = function(limit = 10) {
  return this.find()
    .sort({ createdAt: -1 })
    .limit(limit)
    .populate('user', 'name email')
    .populate('items.product', 'name image');
};

module.exports = mongoose.model('Order', orderSchema);
```

#### **4.1.2 ¬øQu√© incluye este modelo Order?**

**üÜî IDENTIFICACI√ìN:**
- `orderNumber` - N√∫mero √∫nico generado autom√°ticamente
- `user` - Referencia al usuario que hizo la orden
- Relaci√≥n con productos mediante `items`

**üí∞ INFORMACI√ìN FINANCIERA:**
- `subtotalAmount` - Suma de todos los items
- `shippingCost` - Costo de env√≠o
- `tax` - Impuestos aplicados
- `discount` - Descuentos aplicados
- `totalAmount` - Total final calculado autom√°ticamente

**üìã GESTI√ìN DE ESTADOS:**
- `status` - Estado actual de la orden (pending, confirmed, shipped, etc.)
- `paymentStatus` - Estado del pago (pending, paid, failed, etc.)
- `statusHistory` - Historial completo de cambios de estado

**üöö INFORMACI√ìN DE ENV√çO:**
- `shippingAddress` - Direcci√≥n de env√≠o completa
- `billingAddress` - Direcci√≥n de facturaci√≥n
- `trackingNumber` - N√∫mero de seguimiento
- `estimatedDelivery` - Fecha estimada de entrega

**üîß FUNCIONALIDADES AVANZADAS:**
- C√°lculo autom√°tico de totales
- Generaci√≥n autom√°tica de n√∫meros de orden
- M√©todos para gestionar items (agregar, remover)
- M√©todos est√°ticos para estad√≠sticas

---

## ‚úÖ VERIFICACI√ìN DE MODELOS (5 MINUTOS)

### **PASO 5.1: Verificar estructura de archivos**

#### **5.1.1 Comprobar archivos creados**
```bash
cd backend

# Windows
dir models

# Linux/Mac
ls -la models/
```

**Deber√≠as ver:**
```
models/
‚îú‚îÄ‚îÄ index.js
‚îú‚îÄ‚îÄ Product.js
‚îú‚îÄ‚îÄ User.js
‚îî‚îÄ‚îÄ Order.js
```

#### **5.1.2 Verificar que no hay errores de sintaxis**
```bash
# Verificar cada modelo individualmente
node -c models/Product.js
node -c models/User.js  
node -c models/Order.js
node -c models/index.js
```

**Si todo est√° bien, no aparecer√°n mensajes de error.**

### **PASO 5.2: Probar importaci√≥n de modelos**

#### **5.2.1 Crear script de prueba temporal**
**Crear archivo:** `backend/test-models.js`

**PEGAR este contenido:**

```javascript
// Script temporal para probar que los modelos se importan correctamente
require('dotenv').config();
const mongoose = require('mongoose');

// Importar modelos
const { Product, User, Order } = require('./models');

console.log('üß™ Probando importaci√≥n de modelos...');

// Verificar que los modelos se importaron
console.log('‚úÖ Product model:', Product ? '‚úÖ OK' : '‚ùå Error');
console.log('‚úÖ User model:', User ? '‚úÖ OK' : '‚ùå Error');  
console.log('‚úÖ Order model:', Order ? '‚úÖ OK' : '‚ùå Error');

// Verificar esquemas
console.log('\nüìä Informaci√≥n de modelos:');
console.log(`Product fields: ${Object.keys(Product.schema.paths).length} campos`);
console.log(`User fields: ${Object.keys(User.schema.paths).length} campos`);
console.log(`Order fields: ${Object.keys(Order.schema.paths).length} campos`);

console.log('\nüéâ ¬°Todos los modelos se importaron correctamente!');
```

#### **5.2.2 Ejecutar script de prueba**
```bash
node test-models.js
```

**Deber√≠as ver:**
```
üß™ Probando importaci√≥n de modelos...
‚úÖ Product model: ‚úÖ OK
‚úÖ User model: ‚úÖ OK
‚úÖ Order model: ‚úÖ OK

üìä Informaci√≥n de modelos:
Product fields: XX campos
User fields: XX campos  
Order fields: XX campos

üéâ ¬°Todos los modelos se importaron correctamente!
```

#### **5.2.3 Eliminar archivo de prueba**
```bash
del test-models.js  # Windows
rm test-models.js   # Linux/Mac
```

### **PASO 5.3: Verificar conexi√≥n con MongoDB**

#### **5.3.1 Reiniciar servidor para cargar modelos**
```bash
# Si tienes nodemon corriendo, se reiniciar√° autom√°ticamente
# Si usas node, detener con Ctrl+C y reiniciar:
node server.js
```

#### **5.3.2 Verificar endpoints funcionan**
**Probar en navegador:**
- http://localhost:5000/health
- http://localhost:5000/api/db-info  
- http://localhost:5000/api/products

**Todos deben funcionar normalmente.**

---

## üîó RELACIONES ENTRE MODELOS

### **DIAGRAMA DE RELACIONES:**

```
üë§ USER (Usuario)
‚îú‚îÄ‚îÄ üõí ORDER (1:N) - Un usuario puede tener muchas √≥rdenes
‚îÇ   ‚îî‚îÄ‚îÄ üì¶ ORDER ITEMS (1:N) - Una orden puede tener muchos items
‚îÇ       ‚îî‚îÄ‚îÄ üìä PRODUCT (N:1) - Cada item referencia un producto
‚îÇ
‚îî‚îÄ‚îÄ üìù REVIEWS (1:N) - Un usuario puede hacer muchas rese√±as
    ‚îî‚îÄ‚îÄ üìä PRODUCT (N:1) - Cada rese√±a pertenece a un producto
```

### **TIPOS DE RELACIONES IMPLEMENTADAS:**

**üìä Product ‚Üí User (Indirecta):**
- A trav√©s de Order.items
- A trav√©s de reviews (futuro)

**üë§ User ‚Üí Order (Uno a Muchos):**
- `order.user` referencia a `User`
- Un usuario puede tener m√∫ltiples √≥rdenes

**üõí Order ‚Üí Product (Muchos a Muchos):**
- A trav√©s de `order.items.product`
- Una orden puede tener m√∫ltiples productos
- Un producto puede estar en m√∫ltiples √≥rdenes

---

## üìä √çNDICES Y OPTIMIZACIONES IMPLEMENTADAS

### **PRODUCT MODEL:**
- **B√∫squeda de texto:** `name`, `description`, `tags`
- **Filtros:** `category + isActive`
- **Ordenamiento:** `price + rating`
- **Temporal:** `createdAt`
- **Popularidad:** `salesCount`

### **USER MODEL:**
- **Autenticaci√≥n:** `email`
- **Administraci√≥n:** `role`
- **Temporal:** `createdAt`
- **Geogr√°fico:** `address.city`

### **ORDER MODEL:**
- **Por usuario:** `user + createdAt`
- **Identificaci√≥n:** `orderNumber`
- **Estados:** `status + createdAt`
- **Pagos:** `paymentStatus`
- **Productos:** `items.product`

---

## üõ°Ô∏è VALIDACIONES Y SEGURIDAD IMPLEMENTADAS

### **üîí SEGURIDAD:**
- **Passwords encriptados** con bcryptjs (salt 12)
- **Datos sensibles excluidos** por defecto
- **Validaciones de URLs** para im√°genes
- **Sanitizaci√≥n autom√°tica** de strings

### **‚úÖ VALIDACIONES:**
- **Emails √∫nicos** y formato v√°lido
- **Precios positivos** y mayores a 0
- **Stock no negativo**
- **Ratings entre 0-5**
- **L√≠mites de caracteres** en textos
- **Estados v√°lidos** para √≥rdenes

### **üö® MANEJO DE ERRORES:**
- **Mensajes descriptivos** en espa√±ol
- **Validaciones personalizadas** con funciones
- **Middleware de error** integrado
- **Transformaciones autom√°ticas** en JSON

---

## üéØ VERIFICACI√ìN FINAL PARTE 2

### **CHECKLIST DE COMPLETACI√ìN:**

#### **‚úÖ Estructura Creada:**
- [ ] ‚úÖ Carpeta `models/` creada
- [ ] ‚úÖ Archivo `models/index.js` creado
- [ ] ‚úÖ Exportaciones centralizadas funcionando

#### **‚úÖ Modelo Product:**
- [ ] ‚úÖ Archivo `models/Product.js` creado
- [ ] ‚úÖ Todos los campos de tus productos incluidos
- [ ] ‚úÖ Validaciones implementadas
- [ ] ‚úÖ √çndices para b√∫squedas optimizadas
- [ ] ‚úÖ Virtuals y m√©todos funcionando

#### **‚úÖ Modelo User:**
- [ ] ‚úÖ Archivo `models/User.js` creado
- [ ] ‚úÖ bcryptjs instalado y configurado
- [ ] ‚úÖ Encriptaci√≥n autom√°tica de passwords
- [ ] ‚úÖ Sistema de roles implementado
- [ ] ‚úÖ Validaciones de email y datos

#### **‚úÖ Modelo Order:**
- [ ] ‚úÖ Archivo `models/Order.js` creado
- [ ] ‚úÖ Sub-esquema de items implementado
- [ ] ‚úÖ C√°lculos autom√°ticos de totales
- [ ] ‚úÖ Sistema de estados robusto
- [ ] ‚úÖ Relaciones con Product y User

#### **‚úÖ Verificaciones:**
- [ ] ‚úÖ Sintaxis correcta en todos los archivos
- [ ] ‚úÖ Importaciones funcionando
- [ ] ‚úÖ Servidor reinicia sin errores
- [ ] ‚úÖ Endpoints siguen funcionando

### **COMANDOS DE VERIFICACI√ìN:**

```bash
# 1. Verificar estructura
ls -la models/  # Linux/Mac
dir models\     # Windows

# 2. Verificar sintaxis
node -c models/Product.js
node -c models/User.js
node -c models/Order.js

# 3. Verificar importaciones
node -e "console.log(require('./models'))"

# 4. Verificar servidor
node server.js
```

---

## üéâ FELICITACIONES - PARTE 2 COMPLETADA

**üèÜ MODELOS DE DATOS PROFESIONALES CREADOS:**

### **ANTES:**
- ‚ùå Datos simples en arrays JavaScript
- ‚ùå Sin validaciones ni relaciones
- ‚ùå Sin estructura escalable
- ‚ùå Sin seguridad implementada

### **DESPU√âS:**
- ‚úÖ **Modelos robustos** con validaciones completas
- ‚úÖ **Relaciones bien definidas** entre entidades
- ‚úÖ **Seguridad implementada** (encriptaci√≥n, validaciones)
- ‚úÖ **Optimizaciones** (√≠ndices, virtuals, m√©todos)
- ‚úÖ **Escalabilidad** preparada para miles de registros

### **ARQUITECTURA DE DATOS PROFESIONAL:**
- **üìä Product Model:** 20+ campos con validaciones
- **üë§ User Model:** Sistema completo de usuarios con roles
- **üõí Order Model:** Sistema de pedidos robusto
- **üîó Relaciones:** Estructura relacional bien dise√±ada

### **FUNCIONALIDADES AVANZADAS:**
- **Virtuals:** Campos calculados din√°micamente
- **Middleware:** Procesamiento autom√°tico de datos
- **M√©todos:** Funciones espec√≠ficas del negocio
- **√çndices:** B√∫squedas optimizadas
- **Validaciones:** Integridad de datos garantizada

---

## üìã PREPARACI√ìN PARA PARTE 3

### **MANUAL 3 - PARTE 3: CONTROLLERS Y RUTAS API**
**Lo que viene a continuaci√≥n:**
- ‚úÖ **Controllers profesionales** para cada modelo
- ‚úÖ **Rutas API REST** completas (GET, POST, PUT, DELETE)
- ‚úÖ **Migraci√≥n de datos** de memoria a MongoDB
- ‚úÖ **Testing de endpoints** con datos reales
- ‚úÖ **Manejo de errores** robusto

### **YA TIENES PREPARADO:**
- ‚úÖ **3 modelos completos** con validaciones
- ‚úÖ **Relaciones establecidas** entre modelos
- ‚úÖ **Base de datos funcionando** perfectamente
- ‚úÖ **Estructura escalable** para APIs REST

### **CUANDO EST√âS LISTO:**
Dime: **"Listo para Manual 3 - Parte 3"** y continuaremos con la creaci√≥n de controllers y rutas API que usar√°n tus modelos.

---

**üíæ MANUAL 3 - PARTE 2: MODELOS DE DATOS COMPLETADO** ‚úÖ

**Estado:** ‚úÖ Modelos creados y verificados sin errores  
**Tiempo invertido:** ~45 minutos  
**Nivel alcanzado:** Arquitectura de datos profesional  
**Pr√≥ximo paso:** Crear controllers y rutas API  

**üöÄ ¬°EXCELENTE TRABAJO! Has creado una arquitectura de datos robusta y escalable para tu e-commerce.** üõçÔ∏è